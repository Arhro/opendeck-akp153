name: Build Fast opendeck-akp153 (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone mirajazz
        run: git clone https://github.com/4ndv/mirajazz.git

      - name: Patch mirajazz (0.5ms)
        shell: pwsh
        run: |
          $file = "mirajazz/src/state.rs"
          (Get-Content $file) |
            ForEach-Object {
              $_ -replace 'time::sleep\(timeout\)\.await;', 'time::sleep(std::time::Duration::from_micros(500)).await;'
            } | Set-Content $file
          Write-Host "Patch applied"

      - name: Replace mirajazz dependency
        shell: pwsh
        run: |
          $cargo = "Cargo.toml"
          (Get-Content $cargo) |
            ForEach-Object {
              if ($_ -match '^mirajazz') {
                'mirajazz = { path = "mirajazz" }'
              } else {
                $_
              }
            } | Set-Content $cargo

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Show target files
        run: dir target/release

      - name: Upload EXE (auto-detect)
        uses: actions/upload-artifact@v4
        with:
          name: opendeck-akp153-fast
          path: |
            target/release/*.exe
